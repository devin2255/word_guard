# 御言(YuYan) .


## 1. 项目概述

### 1.1 产品介绍
御言是一款专为文本内容风控设计的智能解决方案，旨在帮助企业和平台高效管理用户生成内容(UGC)。通过全面的策略体系、智能算法和灵活配置能力，御言能够精准识别和处理违规、涉政、涉黄等敏感内容，有效保障社区环境的健康与合规。

### 1.2 核心理念
"掌控语言、守护秩序" - 提供灵活的文本过滤方案，无缝集成多种第三方平台，满足复杂场景下的内容审核需求。

### 1.3 技术栈
- **Web框架**: FastAPI
- **ORM**: Tortoise ORM
- **数据库**: MySQL
- **Web服务器**: Uvicorn
- **Python版本**: 3.11+

## 2. 系统架构设计

### 2.1 整体架构
项目采用经典的**领域驱动设计（DDD）四层架构**模式，具体包括：

1. **接口层（Interfaces）**：负责处理用户请求和展示数据
2. **应用层（Application）**：协调领域层业务逻辑，处理用例
3. **领域层（Domain）**：核心业务逻辑实现
4. **基础设施层（Infrastructure）**：提供技术支撑，如数据库访问、外部服务等

此外，还包含**共享内核（Shared Kernel）**，提供通用的枚举、异常、事件等组件。

```
┌─────────────────────────────────────────────────────────────┐
│                     客户端层                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Web UI    │  │  Mobile App │  │  Third API  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                             │
                     HTTP/HTTPS API
                             │
┌─────────────────────────────────────────────────────────────┐
│                    接口层 (Interfaces)                       │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              FastAPI Application                        │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │ │
│  │  │   CORS   │  │   Auth   │  │   Rate   │             │ │
│  │  │Middleware│  │Middleware│  │Limiting  │             │ │
│  │  └──────────┘  └──────────┘  └──────────┘             │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                             │
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Application)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Commands  │  │  Queries    │  │ Handlers    │         │
│  │   命令处理   │  │   查询处理   │  │  处理器      │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                             │
┌─────────────────────────────────────────────────────────────┐
│                    领域层 (Domain)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Entities   │  │ ValueObjects│  │ Repositories│         │
│  │   实体       │  │  值对象      │  │  仓储接口    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────┐  ┌─────────────┐                          │
│  │   Events    │  │  Services   │                          │
│  │  领域事件    │  │  领域服务    │                          │
│  └─────────────┘  └─────────────┘                          │
└─────────────────────────────────────────────────────────────┘
                             │
┌─────────────────────────────────────────────────────────────┐
│                 基础设施层 (Infrastructure)                  │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                Tortoise ORM                             │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │ │
│  │  │ Database │  │  Models  │  │  Repos   │             │ │
│  │  │   模型    │  │   模型    │  │  实现     │             │ │
│  │  └──────────┘  └──────────┘  └──────────┘             │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                             │
┌─────────────────────────────────────────────────────────────┐
│                    数据存储层                                │
│                    MySQL Database                          │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构
```
word_guard/
├── src/                    # 源代码目录
│   ├── domain/            # 领域层 - 核心业务逻辑
│   │   ├── wordlist/      # 名单聚合
│   │   │   ├── entities/     # 实体（聚合根）
│   │   │   ├── value_objects/ # 值对象
│   │   │   ├── repositories/  # 仓储接口
│   │   │   ├── events/        # 领域事件
│   │   │   └── services/      # 领域服务
│   │   └── app/           # 应用聚合
│   ├── application/       # 应用层 - 业务用例协调
│   │   ├── commands/      # 命令对象
│   │   ├── queries/       # 查询对象
│   │   ├── handlers/      # 命令/查询处理器
│   │   └── dto/           # 数据传输对象
│   ├── interfaces/        # 接口层 - 用户接口
│   │   ├── controllers/   # 控制器
│   │   ├── routes/        # 路由配置
│   │   └── dependencies.py # 依赖注入配置
│   ├── infrastructure/    # 基础设施层 - 技术实现
│   │   ├── database/      # 数据库模型
│   │   └── repositories/  # 仓储实现
│   ├── shared/            # 共享内核 - 通用组件
│   │   ├── enums/         # 枚举类型
│   │   ├── exceptions/    # 异常定义
│   │   └── events/        # 事件基类
│   ├── config/            # 配置模块
│   └── main.py            # 应用入口
├── tests/                 # 测试代码
└── migrations/            # 数据库迁移文件
```

## 3. 核心模块详解

### 3.1 领域层 (Domain Layer)

领域层是系统的核心，包含了业务逻辑和规则：

#### 3.1.1 实体（Entities）
如 WordList 是聚合根，包含业务方法和状态，实现了核心业务逻辑。

#### 3.1.2 值对象（Value Objects）
如 ListName、RiskLevel，用于描述实体的特征，具有值语义。

#### 3.1.3 仓储接口（Repository Interfaces）
定义数据访问接口，解耦领域层与基础设施层。

#### 3.1.4 领域事件（Domain Events）
如 WordListCreatedEvent，在业务操作中发布，支持事件驱动架构。

#### 3.1.5 领域服务（Domain Services）
处理跨聚合的业务逻辑。

### 3.2 应用层 (Application Layer)

应用层负责协调领域层对象执行业务用例：

#### 3.2.1 命令（Commands）
如 CreateWordListCommand 表示写操作命令。

#### 3.2.2 查询（Queries）
如 GetWordListQuery 表示读操作查询。

#### 3.2.3 处理器（Handlers）
执行命令和查询的具体逻辑，协调领域对象完成业务用例。

#### 3.2.4 数据传输对象（DTOs）
用于在层间传递数据。

### 3.3 接口层 (Interfaces Layer)

接口层处理用户交互：

#### 3.3.1 控制器（Controllers）
接收HTTP请求，调用应用层处理业务。

#### 3.3.2 路由（Routes）
定义API端点。

#### 3.3.3 依赖注入
通过 dependencies.py 管理组件依赖关系。

### 3.4 基础设施层 (Infrastructure Layer)

基础设施层提供技术实现：

#### 3.4.1 数据库模型
使用 Tortoise ORM 实现的数据库模型。

#### 3.4.2 仓储实现
实现领域层定义的仓储接口。

#### 3.4.3 外部服务适配器
与外部系统的集成。

### 3.5 共享内核 (Shared Kernel)

共享内核提供通用组件：

#### 3.5.1 枚举类型
业务相关的枚举定义。

#### 3.5.2 异常定义
系统级和业务级异常。

#### 3.5.3 事件基类
事件驱动架构的基础类。

## 4. 架构优势

1. **关注点分离**：各层职责明确，便于维护和扩展
2. **可测试性**：领域逻辑独立于基础设施，易于单元测试
3. **可扩展性**：通过接口和依赖注入，易于替换实现
4. **业务表达力**：领域模型准确表达了业务概念和规则
5. **技术解耦**：领域层不依赖具体的技术实现

## 5. 设计模式应用

- **领域驱动设计（DDD）**：聚合根、实体、值对象、仓储等模式
- **CQRS**：命令和查询分离
- **依赖注入**：通过 dependencies.py 管理依赖关系
- **事件驱动**：使用领域事件处理业务流程

## 6. 系统配置

### 6.1 环境配置
通过 `.env` 文件配置环境变量：
- APP_NAME: 应用名称
- APP_ENV: 应用环境 (development/production)
- DATABASE_URL: 数据库连接URL
- DEBUG_MODE: 调试模式开关
- PORT: 服务端口
- SECRET_KEY: 密钥

### 6.2 数据库配置
使用 MySQL 数据库，通过 Tortoise ORM 进行访问，使用 Aerich 进行迁移管理。

## 7. 部署与运行

### 7.1 本地开发
```
python yuyan.py
```

### 7.2 生产部署
```
# 安装依赖
pip install -r requirements.txt

# 运行应用
python yuyan.py
```

访问地址：
- API文档: http://localhost:18000/docs
- 系统信息: http://localhost:18000/
